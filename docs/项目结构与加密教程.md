# 项目结构与机密配置完整指南

本文详细介绍仓库的目录布局、与 `sops-nix` 集成的加密流程，以及从生成密钥到在配置中消费密文的完整操作步骤。本教程假定您已经通过官方安装方式部署好了 Nix，并能够在 shell 中运行 `nix`、`sops` 与 `age` 等命令。

## 1. 仓库结构概览

仓库采用 Nix flake 组织整体配置，核心入口在 [`flake.nix`](../flake.nix)。该文件声明了常用模块输入（`nixpkgs`、`home-manager`、`sops-nix` 等）以及缓存配置，最终通过 `nixos-unified.lib.mkFlake` 暴露输出。【F:flake.nix†L1-L43】

主要目录说明如下：

| 目录 | 作用 |
| --- | --- |
| `configurations/` | 主机与 Home Manager 具体实例（例如 `configurations/nixos/itnucc7jyh` 为 itnucc7jyh 的主机配置）。 |
| `modules/flake/` | Flake 级别的通用模块，例如从密文派生配置的 [`cfg.nix`](../modules/flake/cfg.nix) 与相关的 option 定义 [`cfg-mod.nix`](../modules/flake/cfg-mod.nix)。 |
| `modules/nixos/` | NixOS 层的模块集合，包含基础用户、网络等组件（如 [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) 负责静态 IPv4 逻辑）。 |
| `modules/home/` | Home Manager 的通用模块。 |
| `secrets/` | 存放密文模板与实际加密文件的位置，模板为 [`secrets/cfg.secrets.yaml.example`](../secrets/cfg.secrets.yaml.example)。 |
| `docs/` | 项目文档（当前文件）。 |

## 2. flake 配置模块与密钥消费链路

### 2.1 配置选项

`modules/flake/cfg-mod.nix` 定义了 `flake.config` 可用的选项，其中 `user` 子模块描述默认用户的个人信息，而 `secrets` 以任意属性集形式暴露解密后的数据供其他模块使用。【F:modules/flake/cfg-mod.nix†L1-L35】

### 2.2 机密解析流程

[`modules/flake/cfg.nix`](../modules/flake/cfg.nix) 会按照以下优先级定位密文文件：【F:modules/flake/cfg.nix†L5-L55】

1. 环境变量 `SHINX_SECRETS_FILE` 指向的绝对路径；
2. flake 输入 `secrets`（若上层通过 `inputs.secrets.url` 提供）；
3. 仓库本地的 `secrets/cfg.secrets.yaml`；
4. 兼容性路径 `modules/flake/cfg.secrets.yaml`。

一旦找到文件，模块会调用 `sops-nix.lib.evalSopsFile` 自动解密。若找不到密文则发出警告并回退到模板中的占位数据，以保证 flake 仍可评估。【F:modules/flake/cfg.nix†L17-L46】

解密后的数据会被整理成：

- `config.user`：默认用户信息（含 SSH/GPG 等字段）；
- `config.secrets.network.staticIPv4`：网络静态地址段默认值；
- 其他密钥保持原样，供后续模块按需读取。【F:modules/flake/cfg.nix†L48-L64】

### 2.3 消费示例

- [`modules/nixos/base/user.nix`](../modules/nixos/base/user.nix) 通过 `flake.config.user` 为系统创建真实用户、配置 Home Manager，并在密钥存在时追加 SSH 公钥。【F:modules/nixos/base/user.nix†L1-L24】
- [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) 将 `flake.config.secrets.network.staticIPv4` 作为静态 IP 选项的默认值；在启用时禁用 DHCP、写入 IPv4 地址/路由/DNS，并保证默认用户加入 `networkmanager` 组。【F:modules/nixos/network/default.nix†L1-L74】

## 3. SOPS + Age 加密完整流程

以下步骤假定已在开发环境中安装 `nix`, `sops`, `age`，并可通过本仓库的 devShell 获取（`nix develop` 会拉取 `age` 与 `sops`）。

### 3.1 生成 Age 密钥对

```bash
just secrets-age-key
```

该命令会默认将私钥写入 `~/.config/sops/age/keys.txt`，若文件已存在则直接复用。命令内部会确保父目录存在，并将生成的密钥权限设置为 `600` 以保护私钥。

若需要自定义路径，可在命令后追加 `key_path=/path/to/key`。

### 3.2 准备待加密内容

可以直接编辑模板：

```bash
cp secrets/cfg.secrets.yaml.example /tmp/cfg.secrets.yaml
$EDITOR /tmp/cfg.secrets.yaml
```

修改后的文件包含真实邮箱、SSH 公钥、静态 IP 等敏感信息。

### 3.3 加密并写入仓库

```bash
just secrets-encrypt recipients="age1example..." source=/tmp/cfg.secrets.yaml
```

- `recipients`：至少一个 Age 公钥，多个值以空格分隔；
- `source`：明文文件路径（默认为模板）。

命令会将密文输出到 `secrets/cfg.secrets.yaml`（仓库已通过 `.gitignore` 忽略该文件，避免意外提交明文或密钥）。【F:.gitignore†L1-L9】

如果您已经设置环境变量 `SOPS_AGE_KEY_FILE` 指向私钥，则可直接执行 `sops --encrypt ...`，命令会自动读取。

### 3.4 校验与查看

```bash
just secrets-decrypt
```

命令会调用 `sops --decrypt` 输出 YAML 明文，方便检查内容是否正确。若需要直接编辑密文，可运行：

```bash
just secrets-edit recipients="age1example..."
```

首轮编辑时需提供 `recipients` 以便 `sops` 写入收件人列表；后续若密文已包含收件人信息则可以省略该参数。

### 3.5 在 Nix 配置中使用

1. 确认密文位置：
   - 若存放于仓库根目录 `secrets/cfg.secrets.yaml`，无需额外配置；
   - 若位于其他路径，可在命令行或 `direnv` 中设置 `SHINX_SECRETS_FILE=/abs/path/to/cfg.secrets.yaml`；
   - 也可以在 flake 引用中声明：
     ```nix
     inputs.secrets.url = "git+ssh://git@your-private-repo?dir=secrets";
     ```

2. 运行 `nix flake check --impure` 或 `just chk`，验证所有模块可以在密文解密后通过评估。

3. 需要启用静态 IPv4 时，可在主机配置中设置：
   ```nix
   shinx.network.staticIPv4.enable = true;
   ```
   其余字段若在密文中提供将自动填充，也可在主机上覆盖具体值。

### 3.6 烟雾测试

为确保 `sops` 与 `age` 在当前环境下可以协同工作，可直接运行封装好的烟雾测试命令：

```bash
python scripts/secrets_cli.py smoke
```

命令会在临时目录生成 Age 密钥、使用示例明文加密后再解密一次，并在输出为空时给出错误提示。【F:scripts/secrets_cli.py†L121-L176】

若希望同时拉起仓库的开发环境并复用 `just`，可以执行：

```bash
just secrets-smoke
```

这会通过 `nix develop` 提供 `sops`/`age`/`python` 等依赖后调用同一套逻辑。【F:justfile†L59-L68】

## 4. just 命令速览

除原有的 `fmt`、`chk` 等命令外，本次新增的密钥相关快捷方式如下（位于 [`justfile`](../justfile)）：

| 命令 | 说明 |
| --- | --- |
| `just secrets-age-key [key_path=...]` | 生成或复用 Age 私钥（默认 `~/.config/sops/age/keys.txt`）。 |
| `just secrets-encrypt recipients="..." [source=...] [target=...]` | 使用 `sops` 将明文加密为 `target`，支持一次指定多个 Age 公钥。 |
| `just secrets-decrypt [target=...]` | 解密目标文件并输出到标准输出，便于快速检查。 |
| `just secrets-edit [target=...] [recipients="..."]` | 通过 `sops` 直接编辑密文，必要时可传入新的收件人列表。 |
| `just secrets-check` | 组合执行 `nix flake check --impure` 与一次解密验证，确保密文与配置均有效。 |
| `just secrets-smoke [source=...]` | 在临时目录内生成 Age 密钥并完成示例加解密，验证工具链是否可用。 |【F:justfile†L59-L63】
| `just fmt-check` | 以 `--fail-on-change` 模式运行格式化器，常用于 CI 检查。 |【F:justfile†L23-L25】
| `just ci` | 串联格式检查、`nix flake check` 与密钥烟雾测试，快速模拟 CI 流程。 |
| `just om-ci` | 调用 Omnix 的 `ci run`，使用仓库根目录的 `om.yaml` 统一执行本地 CI。 |【F:justfile†L69-L73】

## 6. Omnix 工具链概览

为了在本地与 CI 之间复用相同的构建与检查逻辑，仓库引入了 [Omnix](https://omnix.page/) 命令行工具，并通过根目录的 [`om.yaml`](../om.yaml) 描述自定义步骤。

### 6.1 安装与入门

- **一次性运行**：`nix --extra-experimental-features "nix-command flakes" run github:juspay/omnix -- --help`
- **常驻安装**：`nix profile install nixpkgs#omnix`
- **开发环境集成**：`nix develop` 时 devShell 已内置 `om` 可执行文件，直接运行 `om <subcommand>` 即可。【F:modules/flake/dev-shell.nix†L11-L24】

常用子命令：

| 子命令 | 作用 |
| --- | --- |
| `om show` | 展示 flake 的 `packages`、`apps`、`checks` 等输出，便于了解可用目标。 |
| `om develop` | 快速启动开发环境，`om develop enter` 等价于 `nix develop`，`om develop shell` 则开启一次性临时 shell。 |
| `om health` | 根据 `om.yaml` 中的基线检查 Nix 版本、direnv/Hombrew 是否准备就绪。 |
| `om ci` | 按 `om.yaml` 描述的步骤运行本地 CI，自动串联构建与自定义命令。 |

### 6.2 `om.yaml` 配置结构

仓库的 [`om.yaml`](../om.yaml) 针对 `ci`、`health`、`develop` 做了统一定义：

- `ci.default.root.dir = "."`：以仓库根目录作为默认子项目，并开启 `build` 步骤构建全部 flake 输出，确保 `nixosConfigurations`/`homeConfigurations` 等目标能正常求值。【F:om.yaml†L1-L18】
- 关闭内置的 `lockfile`、`flake-check` 步骤，转而通过 `custom` 区块显式运行我们需要的检测：
  - `fmt-check`：在 devShell 环境内执行 `nix fmt -- --fail-on-change`，等价于 `just fmt-check`，用于捕获未格式化的代码。
  - `flake-check`：执行 `nix flake check --impure`，验证所有系统与模块在解密配置存在时仍可顺利评估。
  - `secrets-smoke`：直接调用 `python scripts/secrets_cli.py smoke`，确保 Age/SOPS 流程在当前环境可用。【F:om.yaml†L7-L26】
- `health` 要求 Nix 版本至少为 2.18，关闭 `direnv`、`homebrew` 的强制性提示，避免在最小化环境下误报。【F:om.yaml†L27-L33】
- `develop` 区段附带了上手说明，提醒团队成员可以用 `om develop` 进入 devShell。【F:om.yaml†L34-L40】

### 6.3 与 Just、CI 的协作

`just om-ci` 任务封装了 `nix run github:juspay/omnix -- ci run .`，适合在没有 `om` 常驻安装的机器上调用。【F:justfile†L69-L73】

在 CI 中只需安装 `omnix` 后运行 `om ci run . -- --accept-flake-config` 即可完成格式化检查、`flake check` 与密钥烟雾测试，最终还会生成 `result` JSON 方便后续缓存上传。

### 6.4 常见问题

- **提示信任替换源**：首次运行时如提示 `allow configuration setting 'substituters'`，可按照交互输入 `y`，或提前添加 `--accept-flake-config`。`
- **重复进入 devShell**：自定义步骤已在 devShell 内执行，勿再嵌套 `nix develop`；若希望使用 Just，建议直接调用 `just secrets-smoke` 等命令。
- **跨平台执行**：`ci.default.root.systems` 未显式限制，`om ci` 会根据当前机器系统选择合适的输出构建；如需强制矩阵，可参考 Omnix 文档使用 `om ci gh-matrix` 生成配置。

上述命令由 `scripts/secrets_cli.py` 提供具体实现，该脚本封装了 Age 私钥生成、SOPS 加解密、烟雾验证与编辑流程，方便在不同 shell 中复用同一套逻辑。【F:scripts/secrets_cli.py†L1-L208】

## 5. 常见问题排查

- **密文找不到或未生效**：确认 `SHINX_SECRETS_FILE` 是否为绝对路径，或密文是否位于默认目录。`cfg.nix` 会在找不到文件时打印警告信息，提示当前回退到占位配置。【F:modules/flake/cfg.nix†L29-L46】
- **静态 IP 未应用**：检查 `secrets` 中的 `network.staticIPv4.enable` 是否为 `true`，或在主机配置中显式启用。模块要求启用时必须提供 `interface` 与 `address` 两项，否则构建会失败并给出断言错误提示。【F:modules/nixos/network/default.nix†L40-L57】
- **SSH/GPG 信息缺失**：`user.pub-key` 与 `user.gpg-key` 可为空，相关模块会自动跳过对应配置，因此需要在密文中填入真实数据后再运行部署。【F:modules/nixos/base/user.nix†L1-L24】

通过以上流程即可在不泄露敏感信息的前提下完成密钥管理、网络配置与系统构建。建议在 CI 或部署前执行 `just secrets-check`，以确保密文可解密且整体配置通过 flake 检查。

## 6. CI 集成

仓库默认提供 GitHub Actions 工作流 [`ci.yml`](../.github/workflows/ci.yml)，在推送与合并请求时自动执行下列步骤：

1. 使用官方安装器拉起 Nix 并开启 `nix-command`/`flakes` 实验特性；
2. 运行 `nix fmt -- --fail-on-change` 确认格式化规则未被破坏；
3. 执行 `nix flake check --impure` 以验证 flake 输出；
4. 进入开发环境运行 `python scripts/secrets_cli.py smoke`，确保 `sops`/`age` 与密钥工具链可在 CI 环境下运作。【F:.github/workflows/ci.yml†L1-L35】

如需在本地复现，可直接运行 `just ci`，其行为与工作流一致，以便在提交前捕获潜在问题。【F:justfile†L66-L68】
