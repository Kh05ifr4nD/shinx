# é¡¹ç›®ç»“æ„ä¸æœºå¯†é…ç½®å®Œæ•´æŒ‡å—

æœ¬æ–‡è¯¦ç»†ä»‹ç»ä»“åº“çš„ç›®å½•å¸ƒå±€ã€ä¸ `sops-nix` é›†æˆçš„åŠ å¯†æµç¨‹ï¼Œä»¥åŠä»ç”Ÿæˆå¯†é’¥åˆ°åœ¨é…ç½®ä¸­æ¶ˆè´¹å¯†æ–‡çš„å®Œæ•´æ“ä½œæ­¥éª¤ã€‚æœ¬æ•™ç¨‹å‡å®šæ‚¨å·²ç»é€šè¿‡å®˜æ–¹å®‰è£…æ–¹å¼éƒ¨ç½²å¥½äº† Nixï¼Œå¹¶èƒ½å¤Ÿåœ¨ shell ä¸­è¿è¡Œ `nix`ã€`sops` ä¸ `age` ç­‰å‘½ä»¤ã€‚

## 1. ä»“åº“ç»“æ„æ¦‚è§ˆ

ä»“åº“é‡‡ç”¨ Nix flake ç»„ç»‡æ•´ä½“é…ç½®ï¼Œæ ¸å¿ƒå…¥å£åœ¨ [`flake.nix`](../flake.nix)ã€‚è¯¥æ–‡ä»¶å£°æ˜äº†å¸¸ç”¨æ¨¡å—è¾“å…¥ï¼ˆ`nixpkgs`ã€`home-manager`ã€`sops-nix` ç­‰ï¼‰ä»¥åŠç¼“å­˜é…ç½®ï¼Œæœ€ç»ˆé€šè¿‡ `nixos-unified.lib.mkFlake` æš´éœ²è¾“å‡ºã€‚ã€F:flake.nixâ€ L1-L43ã€‘

ä¸»è¦ç›®å½•è¯´æ˜å¦‚ä¸‹ï¼š

| ç›®å½• | ä½œç”¨ |
| --- | --- |
| `configurations/` | ä¸»æœºä¸ Home Manager å…·ä½“å®ä¾‹ï¼ˆä¾‹å¦‚ `configurations/nixos/itnucc7jyh` ä¸º itnucc7jyh çš„ä¸»æœºé…ç½®ï¼‰ã€‚ |
| `modules/flake/` | Flake çº§åˆ«çš„é€šç”¨æ¨¡å—ï¼Œä¾‹å¦‚ä»å¯†æ–‡æ´¾ç”Ÿé…ç½®çš„ [`cfg.nix`](../modules/flake/cfg.nix) ä¸ç›¸å…³çš„ option å®šä¹‰ [`cfg-mod.nix`](../modules/flake/cfg-mod.nix)ã€‚ |
| `modules/nixos/` | NixOS å±‚çš„æ¨¡å—é›†åˆï¼ŒåŒ…å«åŸºç¡€ç”¨æˆ·ã€ç½‘ç»œç­‰ç»„ä»¶ï¼ˆå¦‚ [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) è´Ÿè´£é™æ€ IPv4 é€»è¾‘ï¼‰ã€‚ |
| `modules/home/` | Home Manager çš„é€šç”¨æ¨¡å—ã€‚ |
| `secrets/` | å­˜æ”¾å¯†æ–‡æ¨¡æ¿ä¸å®é™…åŠ å¯†æ–‡ä»¶çš„ä½ç½®ï¼Œæ¨¡æ¿ä¸º [`secrets/cfg.secrets.yaml.example`](../secrets/cfg.secrets.yaml.example)ã€‚ |
| `docs/` | é¡¹ç›®æ–‡æ¡£ï¼ˆå½“å‰æ–‡ä»¶ï¼‰ã€‚ |

## 2. flake é…ç½®æ¨¡å—ä¸å¯†é’¥æ¶ˆè´¹é“¾è·¯

### 2.1 é…ç½®é€‰é¡¹

`modules/flake/cfg-mod.nix` å®šä¹‰äº† `flake.config` å¯ç”¨çš„é€‰é¡¹ï¼Œå…¶ä¸­ `user` å­æ¨¡å—æè¿°é»˜è®¤ç”¨æˆ·çš„ä¸ªäººä¿¡æ¯ï¼Œè€Œ `secrets` ä»¥ä»»æ„å±æ€§é›†å½¢å¼æš´éœ²è§£å¯†åçš„æ•°æ®ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨ã€‚ã€F:modules/flake/cfg-mod.nixâ€ L1-L35ã€‘

### 2.2 æœºå¯†è§£ææµç¨‹

[`modules/flake/cfg.nix`](../modules/flake/cfg.nix) ä¼šæŒ‰ç…§ä»¥ä¸‹ä¼˜å…ˆçº§å®šä½å¯†æ–‡æ–‡ä»¶ï¼šã€F:modules/flake/cfg.nixâ€ L5-L55ã€‘

1. ç¯å¢ƒå˜é‡ `SHINX_SECRETS_FILE` æŒ‡å‘çš„ç»å¯¹è·¯å¾„ï¼›
2. flake è¾“å…¥ `secrets`ï¼ˆè‹¥ä¸Šå±‚é€šè¿‡ `inputs.secrets.url` æä¾›ï¼‰ï¼›
3. ä»“åº“æœ¬åœ°çš„ `secrets/cfg.secrets.yaml`ï¼›
4. å…¼å®¹æ€§è·¯å¾„ `modules/flake/cfg.secrets.yaml`ã€‚

ä¸€æ—¦æ‰¾åˆ°æ–‡ä»¶ï¼Œæ¨¡å—ä¼šè°ƒç”¨ `sops-nix.lib.evalSopsFile` è‡ªåŠ¨è§£å¯†ã€‚è‹¥æ‰¾ä¸åˆ°å¯†æ–‡åˆ™å‘å‡ºè­¦å‘Šå¹¶å›é€€åˆ°æ¨¡æ¿ä¸­çš„å ä½æ•°æ®ï¼Œä»¥ä¿è¯ flake ä»å¯è¯„ä¼°ã€‚ã€F:modules/flake/cfg.nixâ€ L17-L46ã€‘

è§£å¯†åçš„æ•°æ®ä¼šè¢«æ•´ç†æˆï¼š

- `config.user`ï¼šé»˜è®¤ç”¨æˆ·ä¿¡æ¯ï¼ˆå« SSH/GPG ç­‰å­—æ®µï¼‰ï¼›
- `config.secrets.network.staticIPv4`ï¼šç½‘ç»œé™æ€åœ°å€æ®µé»˜è®¤å€¼ï¼›
- å…¶ä»–å¯†é’¥ä¿æŒåŸæ ·ï¼Œä¾›åç»­æ¨¡å—æŒ‰éœ€è¯»å–ã€‚ã€F:modules/flake/cfg.nixâ€ L48-L64ã€‘

### 2.3 æ¶ˆè´¹ç¤ºä¾‹

- [`modules/nixos/base/user.nix`](../modules/nixos/base/user.nix) é€šè¿‡ `flake.config.user` ä¸ºç³»ç»Ÿåˆ›å»ºçœŸå®ç”¨æˆ·ã€é…ç½® Home Managerï¼Œå¹¶åœ¨å¯†é’¥å­˜åœ¨æ—¶è¿½åŠ  SSH å…¬é’¥ã€‚ã€F:modules/nixos/base/user.nixâ€ L1-L24ã€‘
- [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) å°† `flake.config.secrets.network.staticIPv4` ä½œä¸ºé™æ€ IP é€‰é¡¹çš„é»˜è®¤å€¼ï¼›åœ¨å¯ç”¨æ—¶ç¦ç”¨ DHCPã€å†™å…¥ IPv4 åœ°å€/è·¯ç”±/DNSï¼Œå¹¶ä¿è¯é»˜è®¤ç”¨æˆ·åŠ å…¥ `networkmanager` ç»„ã€‚ã€F:modules/nixos/network/default.nixâ€ L1-L74ã€‘

## 3. SOPS + Age åŠ å¯†å®Œæ•´æµç¨‹

ä»¥ä¸‹æ­¥éª¤å‡å®šå·²åœ¨å¼€å‘ç¯å¢ƒä¸­å®‰è£… `nix`, `sops`, `age`ï¼Œå¹¶å¯é€šè¿‡æœ¬ä»“åº“çš„ devShell è·å–ï¼ˆ`nix develop` ä¼šæ‹‰å– `age` ä¸ `sops`ï¼‰ã€‚

### 3.1 ç”Ÿæˆ Age å¯†é’¥å¯¹

```bash
just secrets-age-key
```

è¯¥å‘½ä»¤ä¼šé»˜è®¤å°†ç§é’¥å†™å…¥ `~/.config/sops/age/keys.txt`ï¼Œè‹¥æ–‡ä»¶å·²å­˜åœ¨åˆ™ç›´æ¥å¤ç”¨ã€‚å‘½ä»¤å†…éƒ¨ä¼šç¡®ä¿çˆ¶ç›®å½•å­˜åœ¨ï¼Œå¹¶å°†ç”Ÿæˆçš„å¯†é’¥æƒé™è®¾ç½®ä¸º `600` ä»¥ä¿æŠ¤ç§é’¥ã€‚

è‹¥éœ€è¦è‡ªå®šä¹‰è·¯å¾„ï¼Œå¯åœ¨å‘½ä»¤åè¿½åŠ  `key_path=/path/to/key`ã€‚

### 3.2 å‡†å¤‡å¾…åŠ å¯†å†…å®¹

å¯ä»¥ç›´æ¥ç¼–è¾‘æ¨¡æ¿ï¼š

```bash
cp secrets/cfg.secrets.yaml.example /tmp/cfg.secrets.yaml
$EDITOR /tmp/cfg.secrets.yaml
```

ä¿®æ”¹åçš„æ–‡ä»¶åŒ…å«çœŸå®é‚®ç®±ã€SSH å…¬é’¥ã€é™æ€ IP ç­‰æ•æ„Ÿä¿¡æ¯ã€‚

### 3.3 åŠ å¯†å¹¶å†™å…¥ä»“åº“

```bash
just secrets-encrypt recipients="age1example..." source=/tmp/cfg.secrets.yaml
```

- `recipients`ï¼šç”¨äºå†™å…¥å¯†æ–‡è®¿é—®æƒé™çš„ Age å…¬é’¥åˆ—è¡¨ï¼Œè‡³å°‘æä¾›ä¸€ä¸ªå€¼ã€‚è‹¥éœ€è¦å…è®¸å¤šä½è¿ç»´äººå‘˜è§£å¯†ï¼Œå¯å°†å¤šä¸ªå…¬é’¥ç”¨ç©ºæ ¼åˆ†éš”åæ•´ä½“ä¼ ç»™ `just`ï¼Œä¾‹å¦‚ï¼š
  ```bash
  just secrets-encrypt \
    recipients='age1alice... age1bob...' \
    source=/tmp/cfg.secrets.yaml
  ```
  é€šå¸¸å¯ä»¥ä»å¯†é’¥æ–‡ä»¶ä¸­è¯»å–è‡ªå·±çš„å…¬é’¥ï¼š
  ```bash
  grep '^# public key:' ~/.config/sops/age/keys.txt | awk '{print $4}'
  ```
  å¦‚éœ€å¼•ç”¨å…¶ä»–äººçš„å…¬é’¥ï¼Œå°†å¯¹æ–¹æä¾›çš„ `age1...` å­—ç¬¦ä¸²è¿½åŠ åˆ° `recipients` å‚æ•°å³å¯ã€‚
- `source`ï¼šæ˜æ–‡æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ä¸ºæ¨¡æ¿ï¼‰ã€‚

å‘½ä»¤ä¼šå°†å¯†æ–‡è¾“å‡ºåˆ° `secrets/cfg.secrets.yaml`ï¼ˆä»“åº“å·²é€šè¿‡ `.gitignore` å¿½ç•¥è¯¥æ–‡ä»¶ï¼Œé¿å…æ„å¤–æäº¤æ˜æ–‡æˆ–å¯†é’¥ï¼‰ã€‚ã€F:.gitignoreâ€ L1-L9ã€‘

> ğŸ’¡ **å·¥ä½œæ ‘åŠ è½½æœºåˆ¶**ï¼šç”±äºå¯†æ–‡æœªçº³å…¥ flake æºï¼ŒNix åœ¨è¯„ä¼°æ—¶ä¼šå…ˆå°è¯•è¯»å– `SHINX_SECRETS_FILE` æŒ‡å®šçš„è·¯å¾„ï¼›è‹¥æœªè®¾ç½®ï¼Œåˆ™å›é€€åˆ° `SHINX_WORKTREE`ï¼ˆè‹¥å­˜åœ¨ï¼‰æˆ–å½“å‰å‘½ä»¤æ‰§è¡Œç›®å½•çš„æ ¹è·¯å¾„ï¼ˆ`PWD`ï¼‰ï¼Œåœ¨å…¶ä¸­æŸ¥æ‰¾ `secrets/cfg.secrets.yaml` ä¸æ—§ç‰ˆçš„ `modules/flake/cfg.secrets.yaml`ã€‚å› æ­¤ä¿æŒæ–‡ä»¶åœ¨å·¥ä½œæ ‘å†…å³å¯ï¼Œæ— éœ€å°†å¯†æ–‡çº³å…¥ Git ä»“åº“ã€‚è¯·ç¡®ä¿è¿è¡Œ `nix ... --impure` æˆ–åœ¨ `direnv`/shell ä¸­å¯¼å‡ºä¸Šè¿°ç¯å¢ƒå˜é‡ï¼Œä½¿ flake èƒ½è®¿é—®åˆ°å·¥ä½œæ ‘ã€‚

éšåæ‰§è¡Œï¼š

```bash
just secrets-materialize
```

è¯¥å‘½ä»¤ä¼šä½¿ç”¨ `sops` è§£å¯†å¯†æ–‡å¹¶ç”Ÿæˆ `.direnv/secrets/cfg.secrets.json`ï¼ˆåŒæ ·è¢«å¿½ç•¥ï¼‰ï¼Œä¾› `nix` è¯„ä¼°é˜¶æ®µç›´æ¥è¯»å–ï¼Œé¿å…é¢‘ç¹æ‰‹åŠ¨è§£å¯†ã€‚

å¦‚æœæ‚¨å·²ç»è®¾ç½®ç¯å¢ƒå˜é‡ `SOPS_AGE_KEY_FILE` æŒ‡å‘ç§é’¥ï¼Œåˆ™å¯ç›´æ¥æ‰§è¡Œ `sops --encrypt ...`ï¼Œå‘½ä»¤ä¼šè‡ªåŠ¨è¯»å–ã€‚

### 3.4 æ ¡éªŒä¸æŸ¥çœ‹

```bash
just secrets-decrypt
```

å‘½ä»¤ä¼šè°ƒç”¨ `sops --decrypt` è¾“å‡º YAML æ˜æ–‡ï¼Œæ–¹ä¾¿æ£€æŸ¥å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚è‹¥éœ€è¦ç›´æ¥ç¼–è¾‘å¯†æ–‡ï¼Œå¯è¿è¡Œï¼š

```bash
just secrets-edit recipients="age1example..."
```

é¦–è½®ç¼–è¾‘æ—¶éœ€æä¾› `recipients` ä»¥ä¾¿ `sops` å†™å…¥æ”¶ä»¶äººåˆ—è¡¨ï¼›åç»­è‹¥å¯†æ–‡å·²åŒ…å«æ”¶ä»¶äººä¿¡æ¯åˆ™å¯ä»¥çœç•¥è¯¥å‚æ•°ã€‚

### 3.5 åœ¨ Nix é…ç½®ä¸­ä½¿ç”¨

1. ç¡®è®¤å¯†æ–‡ä½ç½®ï¼š
   - æ¨èä½¿ç”¨ `just secrets-materialize` ç”Ÿæˆçš„ `.direnv/secrets/cfg.secrets.json`ï¼Œflake ä¼šä¼˜å…ˆåŠ è½½è¯¥æ–‡ä»¶ï¼›
   - è‹¥æ‰‹åŠ¨ç»´æŠ¤è§£å¯†æ–‡ä»¶ï¼Œå¯åœ¨å‘½ä»¤è¡Œæˆ– `direnv` ä¸­è®¾ç½® `SHINX_SECRETS_FILE=/abs/path/to/cfg.secrets.json`ï¼ˆæˆ– `.nix`ï¼‰ï¼›
   - ä¹Ÿå¯ä»¥åœ¨ flake å¼•ç”¨ä¸­å£°æ˜ï¼š
     ```nix
     inputs.secrets.url = "git+ssh://git@your-private-repo?dir=secrets";
     ```

2. è¿è¡Œ `nix flake check --impure` æˆ– `just chk`ï¼ŒéªŒè¯æ‰€æœ‰æ¨¡å—å¯ä»¥åœ¨å¯†æ–‡è§£å¯†åé€šè¿‡è¯„ä¼°ã€‚

3. éœ€è¦å¯ç”¨é™æ€ IPv4 æ—¶ï¼Œå¯åœ¨ä¸»æœºé…ç½®ä¸­è®¾ç½®ï¼š
   ```nix
   shinx.network.staticIPv4.enable = true;
   ```
   å…¶ä½™å­—æ®µè‹¥åœ¨å¯†æ–‡ä¸­æä¾›å°†è‡ªåŠ¨å¡«å……ï¼Œä¹Ÿå¯åœ¨ä¸»æœºä¸Šè¦†ç›–å…·ä½“å€¼ã€‚

### 3.6 çƒŸé›¾æµ‹è¯•

ä¸ºç¡®ä¿ `sops` ä¸ `age` åœ¨å½“å‰ç¯å¢ƒä¸‹å¯ä»¥ååŒå·¥ä½œï¼Œå¯ç›´æ¥è¿è¡Œå°è£…å¥½çš„çƒŸé›¾æµ‹è¯•å‘½ä»¤ï¼š

```bash
python scripts/secrets_cli.py smoke
```

å‘½ä»¤ä¼šåœ¨ä¸´æ—¶ç›®å½•ç”Ÿæˆ Age å¯†é’¥ã€ä½¿ç”¨ç¤ºä¾‹æ˜æ–‡åŠ å¯†åå†è§£å¯†ä¸€æ¬¡ï¼Œå¹¶åœ¨è¾“å‡ºä¸ºç©ºæ—¶ç»™å‡ºé”™è¯¯æç¤ºã€‚ã€F:scripts/secrets_cli.pyâ€ L121-L176ã€‘

è‹¥å¸Œæœ›åŒæ—¶æ‹‰èµ·ä»“åº“çš„å¼€å‘ç¯å¢ƒå¹¶å¤ç”¨ `just`ï¼Œå¯ä»¥æ‰§è¡Œï¼š

```bash
just secrets-smoke
```

è¿™ä¼šé€šè¿‡ `nix develop` æä¾› `sops`/`age`/`python` ç­‰ä¾èµ–åè°ƒç”¨åŒä¸€å¥—é€»è¾‘ã€‚ã€F:justfileâ€ L59-L68ã€‘

## 4. just å‘½ä»¤é€Ÿè§ˆ

é™¤åŸæœ‰çš„ `fmt`ã€`chk` ç­‰å‘½ä»¤å¤–ï¼Œæœ¬æ¬¡æ–°å¢çš„å¯†é’¥ç›¸å…³å¿«æ·æ–¹å¼å¦‚ä¸‹ï¼ˆä½äº [`justfile`](../justfile)ï¼‰ï¼š

| å‘½ä»¤ | è¯´æ˜ |
| --- | --- |
| `just secrets-age-key [key_path=...]` | ç”Ÿæˆæˆ–å¤ç”¨ Age ç§é’¥ï¼ˆé»˜è®¤ `~/.config/sops/age/keys.txt`ï¼‰ã€‚ |
| `just secrets-encrypt recipients="..." [source=...] [target=...]` | ä½¿ç”¨ `sops` å°†æ˜æ–‡åŠ å¯†ä¸º `target`ï¼Œæ”¯æŒä¸€æ¬¡æŒ‡å®šå¤šä¸ª Age å…¬é’¥ã€‚ |
| `just secrets-decrypt [target=...]` | è§£å¯†ç›®æ ‡æ–‡ä»¶å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œä¾¿äºå¿«é€Ÿæ£€æŸ¥ã€‚ |
| `just secrets-edit [target=...] [recipients="..."]` | é€šè¿‡ `sops` ç›´æ¥ç¼–è¾‘å¯†æ–‡ï¼Œå¿…è¦æ—¶å¯ä¼ å…¥æ–°çš„æ”¶ä»¶äººåˆ—è¡¨ã€‚ |
| `just secrets-check` | ç»„åˆæ‰§è¡Œ `nix flake check --impure` ä¸ä¸€æ¬¡è§£å¯†éªŒè¯ï¼Œç¡®ä¿å¯†æ–‡ä¸é…ç½®å‡æœ‰æ•ˆã€‚ |
| `just secrets-materialize [source=...] [target=...]` | å°†å¯†æ–‡è§£å¯†ä¸º JSONï¼ˆé»˜è®¤å†™å…¥ `.direnv/secrets/cfg.secrets.json`ï¼‰ï¼Œä¾› flake è¯„ä¼°ç›´æ¥åŠ è½½ã€‚ |
| `just secrets-smoke [source=...]` | åœ¨ä¸´æ—¶ç›®å½•å†…ç”Ÿæˆ Age å¯†é’¥å¹¶å®Œæˆç¤ºä¾‹åŠ è§£å¯†ï¼ŒéªŒè¯å·¥å…·é“¾æ˜¯å¦å¯ç”¨ã€‚ |ã€F:justfileâ€ L59-L68ã€‘
| `just fmt-check` | ä»¥ `--fail-on-change` æ¨¡å¼è¿è¡Œæ ¼å¼åŒ–å™¨ï¼Œå¸¸ç”¨äº CI æ£€æŸ¥ã€‚ |ã€F:justfileâ€ L23-L25ã€‘
| `just ci` | ä¸²è”æ ¼å¼æ£€æŸ¥ã€`nix flake check` ä¸å¯†é’¥çƒŸé›¾æµ‹è¯•ï¼Œå¿«é€Ÿæ¨¡æ‹Ÿ CI æµç¨‹ã€‚ |ã€F:justfileâ€ L66-L68ã€‘

ä¸Šè¿°å‘½ä»¤ç”± `scripts/secrets_cli.py` æä¾›å…·ä½“å®ç°ï¼Œè¯¥è„šæœ¬å°è£…äº† Age ç§é’¥ç”Ÿæˆã€SOPS åŠ è§£å¯†ã€çƒŸé›¾éªŒè¯ä¸ç¼–è¾‘æµç¨‹ï¼Œæ–¹ä¾¿åœ¨ä¸åŒ shell ä¸­å¤ç”¨åŒä¸€å¥—é€»è¾‘ã€‚ã€F:scripts/secrets_cli.pyâ€ L1-L208ã€‘

## 5. å¸¸è§é—®é¢˜æ’æŸ¥

- **å¯†æ–‡æ‰¾ä¸åˆ°æˆ–æœªç”Ÿæ•ˆ**ï¼šç¡®è®¤ `SHINX_SECRETS_FILE` æ˜¯å¦ä¸ºç»å¯¹è·¯å¾„ï¼Œæˆ–å¯†æ–‡æ˜¯å¦ä½äºé»˜è®¤ç›®å½•ã€‚`cfg.nix` ä¼šåœ¨æ‰¾ä¸åˆ°æ–‡ä»¶æ—¶æ‰“å°è­¦å‘Šä¿¡æ¯ï¼Œæç¤ºå½“å‰å›é€€åˆ°å ä½é…ç½®ã€‚ã€F:modules/flake/cfg.nixâ€ L29-L46ã€‘
- **é™æ€ IP æœªåº”ç”¨**ï¼šæ£€æŸ¥ `secrets` ä¸­çš„ `network.staticIPv4.enable` æ˜¯å¦ä¸º `true`ï¼Œæˆ–åœ¨ä¸»æœºé…ç½®ä¸­æ˜¾å¼å¯ç”¨ã€‚æ¨¡å—è¦æ±‚å¯ç”¨æ—¶å¿…é¡»æä¾› `interface` ä¸ `address` ä¸¤é¡¹ï¼Œå¦åˆ™æ„å»ºä¼šå¤±è´¥å¹¶ç»™å‡ºæ–­è¨€é”™è¯¯æç¤ºã€‚ã€F:modules/nixos/network/default.nixâ€ L40-L57ã€‘
- **SSH/GPG ä¿¡æ¯ç¼ºå¤±**ï¼š`user.pub-key` ä¸ `user.gpg-key` å¯ä¸ºç©ºï¼Œç›¸å…³æ¨¡å—ä¼šè‡ªåŠ¨è·³è¿‡å¯¹åº”é…ç½®ï¼Œå› æ­¤éœ€è¦åœ¨å¯†æ–‡ä¸­å¡«å…¥çœŸå®æ•°æ®åå†è¿è¡Œéƒ¨ç½²ã€‚ã€F:modules/nixos/base/user.nixâ€ L1-L24ã€‘

é€šè¿‡ä»¥ä¸Šæµç¨‹å³å¯åœ¨ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯çš„å‰æä¸‹å®Œæˆå¯†é’¥ç®¡ç†ã€ç½‘ç»œé…ç½®ä¸ç³»ç»Ÿæ„å»ºã€‚å»ºè®®åœ¨ CI æˆ–éƒ¨ç½²å‰æ‰§è¡Œ `just secrets-check`ï¼Œä»¥ç¡®ä¿å¯†æ–‡å¯è§£å¯†ä¸”æ•´ä½“é…ç½®é€šè¿‡ flake æ£€æŸ¥ã€‚

## 6. CI é›†æˆ

ä»“åº“é»˜è®¤æä¾› GitHub Actions å·¥ä½œæµ [`ci.yml`](../.github/workflows/ci.yml)ï¼Œåœ¨æ¨é€ä¸åˆå¹¶è¯·æ±‚æ—¶è‡ªåŠ¨æ‰§è¡Œä¸‹åˆ—æ­¥éª¤ï¼š

1. ä½¿ç”¨å®˜æ–¹å®‰è£…å™¨æ‹‰èµ· Nix å¹¶å¼€å¯ `nix-command`/`flakes` å®éªŒç‰¹æ€§ï¼›
2. è¿è¡Œ `nix fmt -- --fail-on-change` ç¡®è®¤æ ¼å¼åŒ–è§„åˆ™æœªè¢«ç ´åï¼›
3. æ‰§è¡Œ `nix flake check --impure` ä»¥éªŒè¯ flake è¾“å‡ºï¼›
4. ç›´æ¥æ‰§è¡Œ `nix run .#secrets-smoke`ï¼Œç¡®ä¿ `sops`/`age` ä¸å¯†é’¥å·¥å…·é“¾å¯åœ¨ CI ç¯å¢ƒä¸‹è¿ä½œï¼›
5. è¿›å…¥å¼€å‘ç¯å¢ƒè°ƒç”¨ `env NIX_CONFIG="experimental-features = nix-command flakes" om ci run . --no-link`ï¼ŒéªŒè¯ `om.yaml` ä¸­å£°æ˜çš„ CI æ­¥éª¤èƒ½å¤Ÿæ•´ä½“é€šè¿‡ã€‚ã€F:.github/workflows/ci.ymlâ€ L1-L38ã€‘

å¦‚éœ€åœ¨æœ¬åœ°å¤ç°ï¼Œå¯ç›´æ¥è¿è¡Œ `just ci`ï¼Œå…¶è¡Œä¸ºä¸å·¥ä½œæµä¸€è‡´ï¼Œä»¥ä¾¿åœ¨æäº¤å‰æ•è·æ½œåœ¨é—®é¢˜ã€‚ã€F:justfileâ€ L66-L68ã€‘

### 6.1 Omnix ä¸ `om ci` æœ¬åœ°éªŒè¯

ä¸ºè¿›ä¸€æ­¥ç»Ÿä¸€æœ¬åœ°ä¸ CI è¡Œä¸ºï¼Œä»“åº“å¼•å…¥ [Omnix](https://omnix.page/) CLI å¹¶åœ¨å¼€å‘ shell ä¸­å†…ç½® `om` å‘½ä»¤ã€‚Omnix æä¾›ä»¥ä¸‹å¸¸ç”¨å­å‘½ä»¤ï¼š

- `om show`ï¼šæšä¸¾ flake è¾“å‡ºï¼Œä¾¿äºå¿«é€Ÿæ ¸å¯¹æ„å»ºç›®æ ‡ï¼›
- `om develop`ï¼šæ ¹æ® flake é…ç½®ç”Ÿæˆå¼€å‘ç¯å¢ƒï¼›
- `om ci`ï¼šæ‰§è¡Œ CI é¢„è®¾æµç¨‹ï¼Œæ”¯æŒæœ¬åœ°æˆ–è¿œç¨‹è¿è¡Œï¼›
- `om health`ï¼šæ£€æŸ¥ Nix å®‰è£…ã€ç¼“å­˜ä¸ direnv ç­‰åŸºç¡€ä¾èµ–çŠ¶æ€ã€‚

ä»“åº“æ ¹ç›®å½•æ–°å¢ `om.yaml`ï¼Œå£°æ˜é»˜è®¤çš„ CI æµç¨‹ï¼š

```yaml
ci:
  default:
    shinx:
      dir: .
      steps:
        build:
          enable: false
        flake-check:
          enable: true
        custom:
          secrets-smoke:
            type: app
            name: secrets-smoke
```

è¯¥é…ç½®ä¼šè·³è¿‡é»˜è®¤çš„ flake `build` é˜¶æ®µï¼ˆç›®å‰ç”± GitHub Actions è´Ÿè´£ï¼‰ï¼Œå…ˆè¿è¡Œ `nix flake check`ï¼Œå†é€šè¿‡ flake app `secrets-smoke` å¯åŠ¨å¯†é’¥çƒŸé›¾æµ‹è¯•ï¼Œä¸ GitHub Actions çš„æ‰§è¡Œé¡ºåºä¿æŒä¸€è‡´ï¼ŒåŒæ—¶é¿å…é‡å¤æ„å»ºå¼€å‘ç¯å¢ƒä¾èµ–ã€‚ã€F:om.yamlâ€ L1-L13ã€‘

è¿›å…¥ `nix develop`ï¼ˆæˆ–ç›´æ¥ä½¿ç”¨ `just om-ci`ï¼‰åå³å¯è¿è¡Œ `env NIX_CONFIG="experimental-features = nix-command flakes" om ci run . --no-link`ï¼Œåœ¨æœ¬åœ°å®Œæ•´å¤ç° CIï¼›å‘½ä»¤ç»“æŸæ—¶å¯é€šè¿‡ç»ˆç«¯æ—¥å¿—ç¡®è®¤å„æ­¥éª¤æ˜¯å¦æˆåŠŸï¼Œé¿å…å¤šä½™çš„ `result` è½¯é“¾æ¥å ç”¨ç£ç›˜ç©ºé—´ã€‚ã€F:justfileâ€ L66-L72ã€‘ã€F:om.yamlâ€ L1-L13ã€‘
