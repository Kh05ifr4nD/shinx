# 项目结构与机密配置完整指南

本文详细介绍仓库的目录布局、与 `sops-nix` 集成的加密流程，以及从生成密钥到在配置中消费密文的完整操作步骤。本教程假定您已经通过官方安装方式部署好了 Nix，并能够在 shell 中运行 `nix`、`sops` 与 `age` 等命令。

## 1. 仓库结构概览

仓库采用 Nix flake 组织整体配置，核心入口在 [`flake.nix`](../flake.nix)。该文件声明了常用模块输入（`nixpkgs`、`home-manager`、`sops-nix` 等）以及缓存配置，最终通过 `nixos-unified.lib.mkFlake` 暴露输出。【F:flake.nix†L1-L43】

主要目录说明如下：

| 目录 | 作用 |
| --- | --- |
| `configurations/` | 主机与 Home Manager 具体实例（例如 `configurations/nixos/itnucc7jyh` 为 itnucc7jyh 的主机配置）。 |
| `modules/flake/` | Flake 级别的通用模块，例如从密文派生配置的 [`cfg.nix`](../modules/flake/cfg.nix) 与相关的 option 定义 [`cfg-mod.nix`](../modules/flake/cfg-mod.nix)。 |
| `modules/nixos/` | NixOS 层的模块集合，包含基础用户、网络等组件（如 [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) 负责静态 IPv4 逻辑）。 |
| `modules/home/` | Home Manager 的通用模块。 |
| `secrets/` | 存放密文模板与实际加密文件的位置，模板为 [`secrets/cfg.secrets.yaml.example`](../secrets/cfg.secrets.yaml.example)。 |
| `docs/` | 项目文档（当前文件）。 |

## 2. flake 配置模块与密钥消费链路

### 2.1 配置选项

`modules/flake/cfg-mod.nix` 定义了 `flake.config` 可用的选项，其中 `user` 子模块描述默认用户的个人信息，而 `secrets` 以任意属性集形式暴露解密后的数据供其他模块使用。【F:modules/flake/cfg-mod.nix†L1-L35】

### 2.2 机密解析流程

[`modules/flake/cfg.nix`](../modules/flake/cfg.nix) 会按照以下优先级定位密文文件：【F:modules/flake/cfg.nix†L5-L55】

1. 环境变量 `SHINX_SECRETS_FILE` 指向的绝对路径；
2. flake 输入 `secrets`（若上层通过 `inputs.secrets.url` 提供）；
3. 仓库本地的 `secrets/cfg.secrets.yaml`；
4. 兼容性路径 `modules/flake/cfg.secrets.yaml`。

一旦找到文件，模块会调用 `sops-nix.lib.evalSopsFile` 自动解密。若找不到密文则发出警告并回退到模板中的占位数据，以保证 flake 仍可评估。【F:modules/flake/cfg.nix†L17-L46】

解密后的数据会被整理成：

- `config.user`：默认用户信息（含 SSH/GPG 等字段）；
- `config.secrets.network.staticIPv4`：网络静态地址段默认值；
- 其他密钥保持原样，供后续模块按需读取。【F:modules/flake/cfg.nix†L48-L64】

### 2.3 消费示例

- [`modules/nixos/base/user.nix`](../modules/nixos/base/user.nix) 通过 `flake.config.user` 为系统创建真实用户、配置 Home Manager，并在密钥存在时追加 SSH 公钥。【F:modules/nixos/base/user.nix†L1-L24】
- [`modules/nixos/network/default.nix`](../modules/nixos/network/default.nix) 将 `flake.config.secrets.network.staticIPv4` 作为静态 IP 选项的默认值；在启用时禁用 DHCP、写入 IPv4 地址/路由/DNS，并保证默认用户加入 `networkmanager` 组。【F:modules/nixos/network/default.nix†L1-L74】

## 3. SOPS + Age 加密完整流程

以下步骤假定已在开发环境中安装 `nix`, `sops`, `age`，并可通过本仓库的 devShell 获取（`nix develop` 会拉取 `age` 与 `sops`）。

### 3.1 生成 Age 密钥对

```bash
just secrets-age-key
```

该命令会默认将私钥写入 `~/.config/sops/age/keys.txt`，若文件已存在则直接复用。命令内部会确保父目录存在，并将生成的密钥权限设置为 `600` 以保护私钥。

若需要自定义路径，可在命令后追加 `key_path=/path/to/key`。

### 3.2 准备待加密内容

可以直接编辑模板：

```bash
cp secrets/cfg.secrets.yaml.example /tmp/cfg.secrets.yaml
$EDITOR /tmp/cfg.secrets.yaml
```

修改后的文件包含真实邮箱、SSH 公钥、静态 IP 等敏感信息。

### 3.3 加密并写入仓库

```bash
just secrets-encrypt recipients="age1example..." source=/tmp/cfg.secrets.yaml
```

- `recipients`：用于写入密文访问权限的 Age 公钥列表，至少提供一个值。若需要允许多位运维人员解密，可将多个公钥用空格分隔后整体传给 `just`，例如：
  ```bash
  just secrets-encrypt \
    recipients='age1alice... age1bob...' \
    source=/tmp/cfg.secrets.yaml
  ```
  通常可以从密钥文件中读取自己的公钥：
  ```bash
  grep '^# public key:' ~/.config/sops/age/keys.txt | awk '{print $4}'
  ```
  如需引用其他人的公钥，将对方提供的 `age1...` 字符串追加到 `recipients` 参数即可。
- `source`：明文文件路径（默认为模板）。

命令会将密文输出到 `secrets/cfg.secrets.yaml`（仓库已通过 `.gitignore` 忽略该文件，避免意外提交明文或密钥）。【F:.gitignore†L1-L9】

> 💡 **工作树加载机制**：由于密文未纳入 flake 源，Nix 在评估时会先尝试读取 `SHINX_SECRETS_FILE` 指定的路径；若未设置，则回退到 `SHINX_WORKTREE`（若存在）或当前命令执行目录的根路径（`PWD`），在其中查找 `secrets/cfg.secrets.yaml` 与旧版的 `modules/flake/cfg.secrets.yaml`。因此保持文件在工作树内即可，无需将密文纳入 Git 仓库。请确保运行 `nix ... --impure` 或在 `direnv`/shell 中导出上述环境变量，使 flake 能访问到工作树。

随后执行：

```bash
just secrets-materialize
```

该命令会使用 `sops` 解密密文并生成 `.direnv/secrets/cfg.secrets.json`（同样被忽略），供 `nix` 评估阶段直接读取，避免频繁手动解密。

如果您已经设置环境变量 `SOPS_AGE_KEY_FILE` 指向私钥，则可直接执行 `sops --encrypt ...`，命令会自动读取。

### 3.4 校验与查看

```bash
just secrets-decrypt
```

命令会调用 `sops --decrypt` 输出 YAML 明文，方便检查内容是否正确。若需要直接编辑密文，可运行：

```bash
just secrets-edit recipients="age1example..."
```

首轮编辑时需提供 `recipients` 以便 `sops` 写入收件人列表；后续若密文已包含收件人信息则可以省略该参数。

### 3.5 在 Nix 配置中使用

1. 确认密文位置：
   - 推荐使用 `just secrets-materialize` 生成的 `.direnv/secrets/cfg.secrets.json`，flake 会优先加载该文件；
   - 若手动维护解密文件，可在命令行或 `direnv` 中设置 `SHINX_SECRETS_FILE=/abs/path/to/cfg.secrets.json`（或 `.nix`）；
   - 也可以在 flake 引用中声明：
     ```nix
     inputs.secrets.url = "git+ssh://git@your-private-repo?dir=secrets";
     ```

2. 运行 `nix flake check --impure` 或 `just chk`，验证所有模块可以在密文解密后通过评估。

3. 需要启用静态 IPv4 时，可在主机配置中设置：
   ```nix
   shinx.network.staticIPv4.enable = true;
   ```
   其余字段若在密文中提供将自动填充，也可在主机上覆盖具体值。

### 3.6 烟雾测试

为确保 `sops` 与 `age` 在当前环境下可以协同工作，可直接运行封装好的烟雾测试命令：

```bash
python scripts/secrets_cli.py smoke
```

命令会在临时目录生成 Age 密钥、使用示例明文加密后再解密一次，并在输出为空时给出错误提示。【F:scripts/secrets_cli.py†L121-L176】

若希望同时拉起仓库的开发环境并复用 `just`，可以执行：

```bash
just secrets-smoke
```

这会通过 `nix develop` 提供 `sops`/`age`/`python` 等依赖后调用同一套逻辑。【F:justfile†L59-L68】

## 4. just 命令速览

除原有的 `fmt`、`chk` 等命令外，本次新增的密钥相关快捷方式如下（位于 [`justfile`](../justfile)）：

| 命令 | 说明 |
| --- | --- |
| `just secrets-age-key [key_path=...]` | 生成或复用 Age 私钥（默认 `~/.config/sops/age/keys.txt`）。 |
| `just secrets-encrypt recipients="..." [source=...] [target=...]` | 使用 `sops` 将明文加密为 `target`，支持一次指定多个 Age 公钥。 |
| `just secrets-decrypt [target=...]` | 解密目标文件并输出到标准输出，便于快速检查。 |
| `just secrets-edit [target=...] [recipients="..."]` | 通过 `sops` 直接编辑密文，必要时可传入新的收件人列表。 |
| `just secrets-check` | 组合执行 `nix flake check --impure` 与一次解密验证，确保密文与配置均有效。 |
| `just secrets-materialize [source=...] [target=...]` | 将密文解密为 JSON（默认写入 `.direnv/secrets/cfg.secrets.json`），供 flake 评估直接加载。 |
| `just secrets-smoke [source=...]` | 在临时目录内生成 Age 密钥并完成示例加解密，验证工具链是否可用。 |【F:justfile†L59-L68】
| `just fmt-check` | 以 `--fail-on-change` 模式运行格式化器，常用于 CI 检查。 |【F:justfile†L23-L25】
| `just ci` | 串联格式检查、`nix flake check` 与密钥烟雾测试，快速模拟 CI 流程。 |【F:justfile†L66-L68】

上述命令由 `scripts/secrets_cli.py` 提供具体实现，该脚本封装了 Age 私钥生成、SOPS 加解密、烟雾验证与编辑流程，方便在不同 shell 中复用同一套逻辑。【F:scripts/secrets_cli.py†L1-L208】

## 5. 常见问题排查

- **密文找不到或未生效**：确认 `SHINX_SECRETS_FILE` 是否为绝对路径，或密文是否位于默认目录。`cfg.nix` 会在找不到文件时打印警告信息，提示当前回退到占位配置。【F:modules/flake/cfg.nix†L29-L46】
- **静态 IP 未应用**：检查 `secrets` 中的 `network.staticIPv4.enable` 是否为 `true`，或在主机配置中显式启用。模块要求启用时必须提供 `interface` 与 `address` 两项，否则构建会失败并给出断言错误提示。【F:modules/nixos/network/default.nix†L40-L57】
- **SSH/GPG 信息缺失**：`user.pub-key` 与 `user.gpg-key` 可为空，相关模块会自动跳过对应配置，因此需要在密文中填入真实数据后再运行部署。【F:modules/nixos/base/user.nix†L1-L24】

通过以上流程即可在不泄露敏感信息的前提下完成密钥管理、网络配置与系统构建。建议在 CI 或部署前执行 `just secrets-check`，以确保密文可解密且整体配置通过 flake 检查。

## 6. CI 集成

仓库默认提供 GitHub Actions 工作流 [`ci.yml`](../.github/workflows/ci.yml)，在推送与合并请求时自动执行下列步骤：

1. 使用官方安装器拉起 Nix 并开启 `nix-command`/`flakes` 实验特性；
2. 运行 `nix fmt -- --fail-on-change` 确认格式化规则未被破坏；
3. 执行 `nix flake check --impure` 以验证 flake 输出；
4. 直接执行 `nix run .#secrets-smoke`，确保 `sops`/`age` 与密钥工具链可在 CI 环境下运作；
5. 进入开发环境调用 `env NIX_CONFIG="experimental-features = nix-command flakes" om ci run . --no-link`，验证 `om.yaml` 中声明的 CI 步骤能够整体通过。【F:.github/workflows/ci.yml†L1-L38】

如需在本地复现，可直接运行 `just ci`，其行为与工作流一致，以便在提交前捕获潜在问题。【F:justfile†L66-L68】

### 6.1 Omnix 与 `om ci` 本地验证

为进一步统一本地与 CI 行为，仓库引入 [Omnix](https://omnix.page/) CLI 并在开发 shell 中内置 `om` 命令。Omnix 提供以下常用子命令：

- `om show`：枚举 flake 输出，便于快速核对构建目标；
- `om develop`：根据 flake 配置生成开发环境；
- `om ci`：执行 CI 预设流程，支持本地或远程运行；
- `om health`：检查 Nix 安装、缓存与 direnv 等基础依赖状态。

仓库根目录新增 `om.yaml`，声明默认的 CI 流程：

```yaml
ci:
  default:
    shinx:
      dir: .
      steps:
        build:
          enable: false
        flake-check:
          enable: true
        custom:
          secrets-smoke:
            type: app
            name: secrets-smoke
```

该配置会跳过默认的 flake `build` 阶段（目前由 GitHub Actions 负责），先运行 `nix flake check`，再通过 flake app `secrets-smoke` 启动密钥烟雾测试，与 GitHub Actions 的执行顺序保持一致，同时避免重复构建开发环境依赖。【F:om.yaml†L1-L13】

进入 `nix develop`（或直接使用 `just om-ci`）后即可运行 `env NIX_CONFIG="experimental-features = nix-command flakes" om ci run . --no-link`，在本地完整复现 CI；命令结束时可通过终端日志确认各步骤是否成功，避免多余的 `result` 软链接占用磁盘空间。【F:justfile†L66-L72】【F:om.yaml†L1-L13】
